<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste Firebase - Ice Beer</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            background: #1a1a1a;
            color: #00ff00;
            padding: 20px;
            margin: 0;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: #000;
            padding: 20px;
            border-radius: 10px;
            border: 2px solid #00ff00;
        }
        
        .test-result {
            margin: 10px 0;
            padding: 10px;
            border-radius: 5px;
            font-weight: bold;
        }
        
        .success {
            background: #0a4a0a;
            color: #00ff00;
            border: 1px solid #00ff00;
        }
        
        .error {
            background: #4a0a0a;
            color: #ff6666;
            border: 1px solid #ff6666;
        }
        
        .warning {
            background: #4a4a0a;
            color: #ffff66;
            border: 1px solid #ffff66;
        }
        
        .info {
            background: #0a0a4a;
            color: #6666ff;
            border: 1px solid #6666ff;
        }
        
        button {
            background: #00ff00;
            color: #000;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
        }
        
        button:hover {
            background: #66ff66;
        }
        
        #log {
            background: #111;
            border: 1px solid #333;
            padding: 15px;
            height: 300px;
            overflow-y: auto;
            font-size: 12px;
            line-height: 1.4;
        }
        
        .step {
            margin: 5px 0;
            padding: 5px;
        }
        
        .step.running {
            color: #ffff66;
        }
        
        .step.success {
            color: #00ff00;
        }
        
        .step.error {
            color: #ff6666;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üî• TESTE DE CONECTIVIDADE FIREBASE</h1>
        <p>Este √© um teste isolado para verificar se o Firebase est√° funcionando corretamente.</p>
        
        <div style="margin: 20px 0;">
            <button onclick="runFullTest()">üß™ EXECUTAR TESTE COMPLETO</button>
            <button onclick="testBasicConnection()">üîó TESTE B√ÅSICO</button>
            <button onclick="testAuthentication()">üîê TESTE AUTH</button>
            <button onclick="testFirestore()">üíæ TESTE FIRESTORE</button>
            <button onclick="clearLog()">üßπ LIMPAR LOG</button>
        </div>
        
        <div id="status" class="test-result info">
            Status: Aguardando teste...
        </div>
        
        <h3>üìã LOG DE EXECU√á√ÉO:</h3>
        <div id="log"></div>
        
        <h3>üìä CONFIGURA√á√ÉO ATUAL:</h3>
        <div id="config"></div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <script>
        // ‚úÖ CONFIGURA√á√ÉO FIREBASE (USE A MESMA DO SEU PROJETO)
        const firebaseConfig = {
            apiKey: "AIzaSyAP-RKDGrnBjSsp0Bo10KUt-9L4I4-1GQU",
            authDomain: "icebeer-gestao.firebaseapp.com",
            projectId: "icebeer-gestao",
            storageBucket: "icebeer-gestao.firebasestorage.app",
            messagingSenderId: "262433847835",
            appId: "1:262433847835:web:d682d91656a1bc703496be",
            measurementId: "G-2L3DF18KSS"
        };

        let app, auth, db;
        
        // ‚úÖ SISTEMA DE LOG
        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const colors = {
                success: '#00ff00',
                error: '#ff6666',
                warning: '#ffff66',
                info: '#6666ff'
            };
            
            const logEntry = document.createElement('div');
            logEntry.innerHTML = `[${timestamp}] <span style="color: ${colors[type]}">${message}</span>`;
            logDiv.appendChild(logEntry);
            logDiv.scrollTop = logDiv.scrollHeight;
            
            console.log(`[${type.toUpperCase()}] ${message}`);
        }
        
        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }
        
        function updateStatus(message, type = 'info') {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = `Status: ${message}`;
            statusDiv.className = `test-result ${type}`;
        }
        
        // ‚úÖ MOSTRAR CONFIGURA√á√ÉO
        function showConfig() {
            const configDiv = document.getElementById('config');
            configDiv.innerHTML = `
                <div class="test-result info">
                    <strong>Project ID:</strong> ${firebaseConfig.projectId}<br>
                    <strong>Auth Domain:</strong> ${firebaseConfig.authDomain}<br>
                    <strong>API Key:</strong> ${firebaseConfig.apiKey.substring(0, 20)}...<br>
                    <strong>Navegador:</strong> ${navigator.userAgent.split(' ').slice(-2).join(' ')}<br>
                    <strong>Online:</strong> ${navigator.onLine ? '‚úÖ Sim' : '‚ùå N√£o'}
                </div>
            `;
        }
        
        // ‚úÖ TESTE COMPLETO
        async function runFullTest() {
            log('üöÄ Iniciando teste completo do Firebase...', 'info');
            updateStatus('Executando testes...', 'warning');
            
            try {
                await testBasicConnection();
                await testAuthentication();
                await testFirestore();
                
                log('üéâ TODOS OS TESTES PASSARAM!', 'success');
                updateStatus('Todos os testes passaram! Firebase est√° funcionando.', 'success');
                
            } catch (error) {
                log(`‚ùå TESTE FALHOU: ${error.message}`, 'error');
                updateStatus(`Teste falhou: ${error.message}`, 'error');
            }
        }
        
        // ‚úÖ TESTE B√ÅSICO DE CONEX√ÉO
        async function testBasicConnection() {
            log('üîó Testando conex√£o b√°sica...', 'info');
            
            try {
                // Verificar se Firebase SDK carregou
                if (typeof firebase === 'undefined') {
                    throw new Error('Firebase SDK n√£o carregado');
                }
                log('‚úÖ Firebase SDK carregado', 'success');
                
                // Inicializar Firebase
                if (!app) {
                    try {
                        app = firebase.app();
                        log('‚ôªÔ∏è Usando app Firebase existente', 'success');
                    } catch (error) {
                        app = firebase.initializeApp(firebaseConfig);
                        log('üÜï Novo app Firebase criado', 'success');
                    }
                }
                
                // Verificar se app foi criado
                if (!app) {
                    throw new Error('Falha ao criar Firebase App');
                }
                log('‚úÖ Firebase App inicializado', 'success');
                
                // Inicializar servi√ßos
                if (!auth) {
                    auth = firebase.auth();
                    log('‚úÖ Firebase Auth inicializado', 'success');
                }
                
                if (!db) {
                    db = firebase.firestore();
                    log('‚úÖ Firestore inicializado', 'success');
                }
                
                // Teste de configura√ß√£o do Firestore
                db.settings({
                    timestampsInSnapshots: true,
                    merge: true,
                    ignoreUndefinedProperties: true
                });
                log('‚úÖ Firestore configurado', 'success');
                
                log('üéØ Conex√£o b√°sica: SUCESSO', 'success');
                return true;
                
            } catch (error) {
                log(`‚ùå Erro na conex√£o b√°sica: ${error.message}`, 'error');
                throw error;
            }
        }
        
        // ‚úÖ TESTE DE AUTENTICA√á√ÉO
        async function testAuthentication() {
            log('üîê Testando autentica√ß√£o...', 'info');
            
            try {
                if (!auth) {
                    throw new Error('Auth n√£o inicializado');
                }
                
                // Fazer logout primeiro
                try {
                    await auth.signOut();
                    log('üö™ Logout realizado', 'success');
                } catch (error) {
                    log('‚ÑπÔ∏è Nenhum usu√°rio para logout', 'info');
                }
                
                // Testar cria√ß√£o/login de usu√°rio
                const testEmail = 'test@icebeer.local';
                const testPassword = 'test123';
                
                log(`üîë Testando login com ${testEmail}...`, 'info');
                
                try {
                    // Tentar fazer login
                    const userCredential = await auth.signInWithEmailAndPassword(testEmail, testPassword);
                    log('‚úÖ Login bem-sucedido', 'success');
                    
                } catch (loginError) {
                    if (loginError.code === 'auth/user-not-found') {
                        log('üë§ Usu√°rio n√£o encontrado, criando...', 'warning');
                        
                        try {
                            const newUserCredential = await auth.createUserWithEmailAndPassword(testEmail, testPassword);
                            log('‚úÖ Usu√°rio criado e logado', 'success');
                        } catch (createError) {
                            throw new Error(`Erro ao criar usu√°rio: ${createError.code}`);
                        }
                        
                    } else {
                        throw new Error(`Erro de login: ${loginError.code}`);
                    }
                }
                
                // Verificar se est√° logado
                const currentUser = auth.currentUser;
                if (!currentUser) {
                    throw new Error('Usu√°rio n√£o est√° logado ap√≥s autentica√ß√£o');
                }
                
                log(`‚úÖ Usu√°rio autenticado: ${currentUser.email}`, 'success');
                
                // Fazer logout
                await auth.signOut();
                log('üö™ Logout de teste realizado', 'success');
                
                log('üéØ Autentica√ß√£o: SUCESSO', 'success');
                return true;
                
            } catch (error) {
                log(`‚ùå Erro na autentica√ß√£o: ${error.message}`, 'error');
                throw error;
            }
        }
        
        // ‚úÖ TESTE DO FIRESTORE
        async function testFirestore() {
            log('üíæ Testando Firestore...', 'info');
            
            try {
                if (!db) {
                    throw new Error('Firestore n√£o inicializado');
                }
                
                // Teste de escrita
                log('üìù Testando escrita no Firestore...', 'info');
                const testDocRef = db.collection('_test').doc('connectivity');
                
                await testDocRef.set({
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    test: true,
                    browser: navigator.userAgent,
                    message: 'Teste de conectividade'
                });
                
                log('‚úÖ Escrita no Firestore bem-sucedida', 'success');
                
                // Teste de leitura
                log('üìñ Testando leitura do Firestore...', 'info');
                const doc = await testDocRef.get();
                
                if (!doc.exists) {
                    throw new Error('Documento n√£o foi encontrado ap√≥s escrita');
                }
                
                const data = doc.data();
                log(`‚úÖ Leitura bem-sucedida: ${JSON.stringify(data.message)}`, 'success');
                
                // Teste de atualiza√ß√£o
                log('‚úèÔ∏è Testando atualiza√ß√£o...', 'info');
                await testDocRef.update({
                    updated: true,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                log('‚úÖ Atualiza√ß√£o bem-sucedida', 'success');
                
                // Limpar teste
                log('üßπ Limpando dados de teste...', 'info');
                await testDocRef.delete();
                log('‚úÖ Limpeza conclu√≠da', 'success');
                
                log('üéØ Firestore: SUCESSO', 'success');
                return true;
                
            } catch (error) {
                if (error.code === 'permission-denied') {
                    log('üîí Erro de permiss√£o (normal se regras n√£o est√£o aplicadas)', 'warning');
                    log('‚ÑπÔ∏è Firebase conecta, mas precisa configurar regras de seguran√ßa', 'info');
                    return true; // Considerar sucesso parcial
                } else {
                    log(`‚ùå Erro no Firestore: ${error.message}`, 'error');
                    throw error;
                }
            }
        }
        
        // ‚úÖ INICIALIZA√á√ÉO
        document.addEventListener('DOMContentLoaded', () => {
            log('üöÄ Teste de conectividade Firebase iniciado', 'info');
            showConfig();
            
            // Verificar se Firebase SDK carregou
            if (typeof firebase === 'undefined') {
                log('‚ùå Firebase SDK n√£o carregado!', 'error');
                updateStatus('Firebase SDK n√£o carregado', 'error');
            } else {
                log('‚úÖ Firebase SDK detectado', 'success');
                updateStatus('Pronto para testes', 'success');
            }
        });
        
        // ‚úÖ FUN√á√ÉO GLOBAL PARA DEBUG
        window.debugFirebase = {
            config: firebaseConfig,
            app: () => app,
            auth: () => auth,
            db: () => db,
            test: runFullTest,
            log: log
        };
        
        // ‚úÖ LOG INICIAL
        log('üî• Sistema de teste carregado. Clique em "EXECUTAR TESTE COMPLETO" para come√ßar.', 'info');
    </script>
</body>
</html>